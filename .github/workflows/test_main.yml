name: CI/CD Pipeline with Documentation

on:
  push:
    branches: [main, development, release]
  pull_request:
    branches: [main, development, release]
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Run tests
      run: |
        python -m unittest test_py -v

  automerge:
    needs: test
    if: github.event_name == 'pull_request' && github.base_ref == 'main' && github.head_ref == 'development' && success()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup GitHub CLI
        run: |
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
      - name: Merge Pull Request
        run: |
          echo "Мержим #${{ github.event.pull_request.number }}..."
          gh pr merge ${{ github.event.pull_request.number }} --merge --admin
          echo "✅"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  documentation:
    needs: test
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/release') ||
      github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Generate documentation
        run: |
          echo "# Документация проекта" > documentation.md
          echo "## Информация о сборке" >> documentation.md
          echo "- Версия: 1.0.0" >> documentation.md
          echo "- Дата сборки: $(date)" >> documentation.md
          echo "- Коммит: ${{ github.sha }}" >> documentation.md
          echo "- Ветка: ${{ github.ref_name }}" >> documentation.md
          echo "" >> documentation.md
          echo "## Последние изменения" >> documentation.md
          echo "Последние 3 коммита:" >> documentation.md
          echo '```' >> documentation.md
          git log --oneline -3 >> documentation.md
          echo '```' >> documentation.md
          echo "" >> documentation.md
          echo "## Файлы проекта" >> documentation.md
          echo "Содержимое репозитория:" >> documentation.md
          echo '```' >> documentation.md
          find . -type f -name "*.py" -o -name "*.md" -o -name "*.yml" | head -20 >> documentation.md
          echo '```' >> documentation.md
          echo "" >> documentation.md
          echo "## Статус" >> documentation.md
          echo "Лабораторная работа завершена" >> documentation.md
          echo "Документация обновляется автоматически при каждом изменении кода" >> documentation.md
      - name: Display documentation
        run: |
          echo "=== СГЕНЕРИРОВАННАЯ ДОКУМЕНТАЦИЯ ==="
          cat documentation.md
          echo "=== КОНЕЦ ДОКУМЕНТАЦИИ ==="
      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: generated-docs
          path: documentation.md
          retention-days: 30
