name: test_main

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Run tests
      run: |
        python -m unittest test_py -v

  automerge:
    needs: test
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/development') ||
      (github.event_name == 'pull_request' && github.base_ref == 'main' && github.head_ref == 'development' && success())
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup GitHub CLI
      run: |
        gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
    - name: Create and Merge PR
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          echo "ðŸ”„ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Pull Request..."
          PR_URL=$(gh pr create --base main --head development --title "Auto PR: Development to Main" --body "Automatically created from development branch" --draft false)
          echo "âœ… PR ÑÐ¾Ð·Ð´Ð°Ð½: $PR_URL"
          PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]\+$')
        else
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "ðŸ”¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ PR: $PR_NUMBER"
        fi
        
        echo "ðŸ”„ ÐœÐµÑ€Ð¶Ð¸Ð¼ PR #$PR_NUMBER..."
        gh pr merge $PR_NUMBER --merge
        echo "âœ…"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
