name: test_main

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Run tests
      run: |
        python -m unittest test_py -v

  automerge:
    needs: test
    if: github.ref == 'refs/heads/development'
    runs-on: ubuntu-latest
    steps:
    - name: Debug info
      run: |
        echo "üéØ Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
        echo "GITHUB_REF: $GITHUB_REF"
        echo "GITHUB_HEAD_REF: $GITHUB_HEAD_REF"
        echo "GITHUB_BASE_REF: $GITHUB_BASE_REF"
        echo "Event: ${{ github.event_name }}"
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup GitHub CLI
      run: |
        gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
        
    - name: Create and Merge PR
      run: |
        echo "üîÑ –°–æ–∑–¥–∞–µ–º Pull Request..."
        PR_URL=$(gh pr create --base main --head development --title "Auto PR: Development to Main" --body "Automatically created from development branch" --draft false)
        echo "‚úÖ PR —Å–æ–∑–¥–∞–Ω: $PR_URL"
        
        PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]\+$')
        echo "üî¢ –ù–æ–º–µ—Ä PR: $PR_NUMBER"
        
        echo "üîÑ –ú–µ—Ä–∂–∏–º PR..."
        gh pr merge $PR_NUMBER --merge
        echo "‚úÖ"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
