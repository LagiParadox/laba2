name: CI/CD Pipeline with Documentation

on:
  push:
    branches: [main, development, release]
  pull_request:
    branches: [main, development, release]
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    - name: Run tests
      run: |
        python -m unittest test_py -v

  automerge:
    needs: test
    if: github.event_name == 'pull_request' && github.base_ref == 'main' && github.head_ref == 'development' && success()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup GitHub CLI
        run: |
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
      - name: Merge Pull Request
        run: |
          echo "–ú–µ—Ä–∂–∏–º #${{ github.event.pull_request.number }}..."
          gh pr merge ${{ github.event.pull_request.number }} --merge --admin
          echo "‚úÖ"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  documentation:
    needs: test
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/release') ||
      github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Generate documentation
        run: |
          echo "# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞" > documentation.md
          echo "–í–µ—Ä—Å–∏—è: 1.0.0" >> documentation.md
          echo "–î–∞—Ç–∞: $(date)" >> documentation.md
          echo "" >> documentation.md
          echo "## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:" >> documentation.md
          echo "- CI/CD –ø–∞–π–ø–ª–∞–π–Ω" >> documentation.md
          echo "- –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã" >> documentation.md
          echo "- –ê–≤—Ç–æ–º–µ—Ä–∂ PR" >> documentation.md
          echo "- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è" >> documentation.md
          echo "" >> documentation.md
          echo "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ó–ê–í–ï–†–®–ï–ù–ê üéâ" >> documentation.md
      - name: Display documentation
        run: |
          echo "=== –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø ==="
          cat documentation.md
          echo "=== –ö–û–ù–ï–¶ –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò ==="
      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: generated-docs
          path: documentation.md
          retention-days: 30
